<div class="animate-fade-in-down p-4">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-primary flex items-center gap-2">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-8"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"
          />
        </svg>
        Historial de Préstamos
      </h1>
      <p class="text-base-content/70 mt-1">
        Control de devoluciones y préstamos activos.
      </p>
    </div>
  </div>

  @if (loading) {
    <div class="flex justify-center py-20">
      <span class="loading loading-bars loading-lg text-primary"></span>
    </div>
  }

  @if (!loading) {
    <div
      class="overflow-x-auto bg-base-100 rounded-lg shadow border border-base-200"
    >
      <table class="table table-zebra w-full">
        <thead class="bg-base-200 text-base-content">
          <tr>
            <th>Libro Prestado</th>
            <th>Estudiante / Cliente</th>
            <th>Fecha Préstamo</th>
            <th>Estado</th>
            <th class="text-right">Acción</th>
          </tr>
        </thead>

        <tbody>
          @for (loan of loans; track loan.idPrestamo) {
            <tr class="hover">
              <td>
                <div class="flex items-center gap-3">
                  <div class="avatar">
                    <div class="mask mask-squircle w-12 h-16 bg-base-300">
                      <img
                        [src]="loan.libro?.imagenUrl || 'assets/images/no-image.jpg'"
                        alt="Portada"
                      />
                    </div>
                  </div>
                  <div>
                    <div class="font-bold">
                      {{ loan.libro?.titulo || "Libro desconocido" }}
                    </div>
                    <div class="text-xs opacity-50">
                      {{ loan.libro?.autor || "Autor desconocido" }}
                    </div>
                  </div>
                </div>
              </td>

              <td>
                <div class="font-semibold">
                  {{ loan.usuario?.nombre }} {{ loan.usuario?.apellido }}
                </div>
                <div
                  class="text-xs opacity-50 badge badge-ghost badge-sm font-mono mt-1"
                >
                  {{ loan.usuario?.cedula }}
                </div>
              </td>

              <td class="text-sm">
                {{ loan.fechaPrestamo | date: "mediumDate" }} <br />
                <span class="text-xs opacity-50">{{
                  loan.fechaPrestamo | date: "shortTime"
                }}</span>
              </td>

              <td>
                @if (loan.fechaDevolucion) {
                  <div class="badge badge-success badge-outline gap-1">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-3 h-3"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m4.5 12.75 6 6 9-13.5"
                      />
                    </svg>
                    Devuelto
                  </div>
                  <div class="text-[10px] opacity-50 mt-1">
                    {{ loan.fechaDevolucion | date: "shortDate" }}
                  </div>
                } @else {
                  <div
                    class="badge badge-error badge-outline gap-1 animate-pulse"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-3 h-3"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
                      />
                    </svg>
                    Pendiente
                  </div>
                }
              </td>

              <td class="text-right">
                @if (!loan.fechaDevolucion) {
                  <button
                    class="btn btn-primary btn-sm btn-outline gap-2"
                    (click)="devolverLibro(loan)"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-4 h-4"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3"
                      />
                    </svg>
                    Devolver
                  </button>
                } @else {
                  <span
                    class="text-success text-sm font-bold flex justify-end items-center gap-1"
                  >
                    ✔ Completado
                  </span>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  @if (!loading && loans.length === 0) {
    <div class="text-center py-10 opacity-50">
      <p>No hay registros de préstamos.</p>
    </div>
  }
</div>
